name: 'Review coding challenge'

on:
  workflow_dispatch:
    inputs:
      reviewer:
        description: 'GitHub user (reviewer)'
        required: true
      repo:
        description: 'GitHub repository'
        required: true
      assignment:
        description: 'Assignment type'
        required: true
        type: choice
        default: 'go'
        options: 
        - 'go'

jobs:
  review-challenge:
    name: 'Review challenge'
    runs-on: ubuntu-latest
    steps:

    - uses: actions/github-script@v5
      id: prepare-for-review
      with:
        github-token: ${{ secrets.PAT }}
        script: |
          const user = "${{ github.event.inputs.reviewer }}"
          const assignment = "${{ github.event.inputs.assignment }}"
          const repoOwner = context.repo.owner
          const repo = "${{ github.event.inputs.repo }}"
        
          const fs = require("fs")
          const path = require('path')

          const { data: ref } = await github.rest.git.getRef({
            owner: repoOwner,
            repo: repo,
            ref: 'heads/main'
          })

          const { data: commit } = await github.rest.git.getCommit({
            owner: repoOwner,
            repo: repo,
            commit_sha: ref.object.sha,
          })

          const patterns = [`${assignment}/**/review.yml`]
          const globber = await glob.create(patterns.join('\n'))
          
          const files = []
          for await (const file of globber.globGenerator()) {
            
            if (fs.lstatSync(file).isDirectory()) {
              continue;
            }

            const content = fs.readFileSync(file, 'utf8')
            
            const { data: blob } = await github.rest.git.createBlob({
              owner: repoOwner,
              repo: repo,
              content: content,
              encoding: 'utf-8'
            })

            files.push({
              path: path.relative(`${{ github.workspace }}/${assignment}`, file),
              mode: '100644',
              type: 'blob',
              sha: blob.sha
            })
          }

          const { data: tree } = await github.rest.git.createTree({
            owner: repoOwner,
            repo: repo,
            tree: files,
            base_tree: commit.tree.sha
          })

          const { data: newCommit } = await github.rest.git.createCommit({
            owner: repoOwner,
            repo: repo,
            message: "Commit review automation workflows ðŸ¤–",
            tree: tree.sha
          })

          await github.rest.git.updateRef({
            owner: repoOwner,
            repo: repo,
            ref: 'heads/main',
            sha: newCommit.sha,
            force: true
          })
